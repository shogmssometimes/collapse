import{r as d,j as e,D as x,R as j,c as O}from"./index-BEapEdjv.js";const k="collapse.mode",y=t=>`/collapse/${t}`,C=()=>{if(typeof window>"u")return"hub";const t=window.location.hash.replace(/^#\/?/,""),[s,n]=t.split(/[\/?]/);return s==="player"?n==="ops"?"player-ops":"player":s==="gm"?n==="ops"?"gm-ops":"gm":s==="chud"?"chud":s==="csmatrix"?"csmatrix":"hub"},B=()=>{if(typeof window>"u")return"player";const t=window.localStorage.getItem(k),s=C();return s==="gm"||s==="gm-ops"?"gm":s==="player"||s==="player-ops"||s==="chud"||s==="csmatrix"?"player":t??"player"},N=({title:t,src:s,onBack:n,note:r,actions:o,actionsClassName:c,frameRef:m,onFrameLoad:u})=>e.jsxs("main",{style:{minHeight:"100vh",display:"flex",flexDirection:"column"},children:[e.jsxs("header",{className:"topbar",children:[e.jsx("button",{className:"ghost-btn ghost-btn-icon",onClick:n,"aria-label":"Back to hub",children:e.jsx("span",{"aria-hidden":"true",children:"←"})}),e.jsxs("div",{className:"topbar-title",children:[e.jsx("div",{className:"muted",style:{fontSize:"0.85rem"},children:"Collapse Full Build"}),e.jsx("strong",{children:t})]}),o?e.jsx("div",{className:c||"topbar-actions",children:o}):null]}),e.jsx("div",{className:"subapp-frame",children:e.jsx("iframe",{title:t,src:s,ref:m,onLoad:u,style:{border:"none"},allow:"fullscreen",sandbox:"allow-same-origin allow-scripts allow-forms allow-popups allow-pointer-lock"})})]}),M=({onBack:t,children:s,chudDock:n})=>{const r=()=>{typeof window<"u"&&window.dispatchEvent(new Event("chud-open"))};return e.jsxs("div",{className:"player-shell",style:{minHeight:"100vh",background:"var(--bg-dark)"},children:[e.jsxs("header",{className:"topbar",children:[e.jsx("button",{className:"ghost-btn ghost-btn-icon",onClick:t,"aria-label":"Back to hub",children:e.jsx("span",{"aria-hidden":"true",children:"←"})}),e.jsxs("div",{className:"topbar-title",children:[e.jsx("div",{className:"muted",style:{fontSize:"0.85rem"},children:"Collapse Full Build"}),e.jsx("strong",{children:"Collapse Companion"})]}),e.jsx("div",{className:"topbar-actions",children:e.jsx("button",{className:"chud-top-btn",onClick:r,"aria-label":"Open cHUD overlay",children:"cHUD"})})]}),n,s]})},S=({onBack:t,children:s,chudDock:n,style:r})=>{const o=()=>{typeof window<"u"&&window.dispatchEvent(new Event("chud-open"))};return e.jsxs("div",{className:"gm-shell",style:{minHeight:"100vh",background:"var(--bg-dark)",...r},children:[e.jsxs("header",{className:"topbar",children:[e.jsx("button",{className:"ghost-btn ghost-btn-icon",onClick:t,"aria-label":"Back to hub",children:e.jsx("span",{"aria-hidden":"true",children:"←"})}),e.jsxs("div",{className:"topbar-title",children:[e.jsx("div",{className:"muted",style:{fontSize:"0.85rem"},children:"Collapse GM Companion"}),e.jsx("strong",{children:"GM Tools"})]}),e.jsx("div",{className:"topbar-actions",children:e.jsx("button",{className:"chud-top-btn",onClick:o,"aria-label":"Open cHUD overlay",children:"cHUD"})})]}),n,s]})},D=({eyebrow:t,title:s,description:n,helper:r})=>e.jsx("div",{className:"page",children:e.jsxs("div",{className:"page-header",children:[e.jsxs("div",{children:[e.jsx("div",{className:"muted",style:{fontSize:"0.9rem",textTransform:"uppercase",letterSpacing:"0.08em"},children:t}),e.jsx("h1",{style:{margin:"0.15rem 0 0.35rem 0"},children:s}),e.jsx("p",{className:"muted",style:{margin:0},children:n})]}),r&&e.jsx("div",{className:"muted text-body",style:{maxWidth:320,textAlign:"right"},children:r})]})}),H=({basePath:t})=>{const[s,n]=j.useState(!1);return j.useEffect(()=>{const r=()=>n(!0);return window.addEventListener("chud-open",r),()=>window.removeEventListener("chud-open",r)},[]),e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"chud-fab",onClick:()=>n(!0),"aria-label":"Open cHUD overlay",children:"cHUD"}),s&&e.jsx("div",{className:"chud-overlay",role:"dialog","aria-modal":"true","aria-label":"cHUD overlay",children:e.jsxs("div",{className:"chud-sheet",children:[e.jsxs("div",{className:"chud-sheet-header",children:[e.jsx("span",{children:"cHUD"}),e.jsx("button",{className:"chud-close",onClick:()=>n(!1),"aria-label":"Close cHUD",children:"✕"})]}),e.jsx("div",{className:"chud-sheet-body",children:e.jsx("iframe",{title:"cHUD",src:`${t}chud/index.html`,allow:"fullscreen",sandbox:"allow-same-origin allow-scripts allow-forms allow-popups allow-pointer-lock"})})]})})]})},U=({mode:t,onModeChange:s,onNavigate:n})=>{const r=d.useMemo(()=>[{id:"player",title:"Deck Builder",description:"Player-facing tools with deck builder and ops.",audience:"player"},{id:"player-ops",title:"Deck Ops",description:"Standalone deck operations for the player deck.",audience:"player"},{id:"gm",title:"Companion — GM",description:"GM-only deck tools with pure counts.",audience:"gm",subtitle:"GM"},{id:"gm-ops",title:"Deck Ops — GM",description:"Standalone deck operations for the GM deck.",audience:"gm",subtitle:"GM"},{id:"csmatrix",title:"CS Matrix",description:"Campaign Support Matrix with draggable nodes.",audience:"player"},{id:"chud",title:"cHUD",description:"Compact HUD for derived stats.",audience:"player"}].filter(c=>c.audience===t),[t]);return e.jsx("main",{className:"hub-landing",children:e.jsxs("div",{className:"hub-landing-content",style:{width:"min(1100px, 100%)",padding:"1.25rem 1rem"},children:[e.jsx("div",{style:{display:"flex",justifyContent:"center"},children:e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{className:`mode-toggle ${t==="player"?"active":""}`,onClick:()=>s("player"),"aria-pressed":t==="player",children:"Player"}),e.jsx("button",{className:`mode-toggle ${t==="gm"?"active":""}`,onClick:()=>s("gm"),"aria-pressed":t==="gm",children:"GM"})]})}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:"1rem",marginTop:"1.1rem"},children:r.map(o=>e.jsxs("button",{style:{border:"1px solid var(--border)",borderRadius:16,padding:"1rem",background:"var(--surface)",minHeight:126,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:"0.5rem",textAlign:"center",cursor:"pointer"},onClick:()=>n(o.id),children:[e.jsx("h2",{style:{margin:0},children:o.title}),o.subtitle?e.jsx("span",{style:{color:"var(--muted)",fontSize:"0.9rem"},children:o.subtitle}):null,e.jsx("p",{style:{color:"var(--muted)",margin:"0.25rem 0"},children:o.description})]},o.id))})]})})};function A(){const[t,s]=d.useState(()=>C()),[n,r]=d.useState(()=>B()),o=d.useRef(null),[c,m]=d.useState({controlsOpen:!1,nodesOpen:!1}),u=t!=="chud"?e.jsx(H,{basePath:y("")}):null;d.useEffect(()=>{const a=()=>{const p=C();if(s(p),p==="gm"||p==="gm-ops")r("gm");else if(p==="player"||p==="player-ops")r("player");else{const f=typeof window<"u"?window.localStorage.getItem(k):null;f&&r(f)}};return a(),window.addEventListener("hashchange",a),window.addEventListener("popstate",a),()=>{window.removeEventListener("hashchange",a),window.removeEventListener("popstate",a)}},[]),d.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(k,n)},[n]),d.useEffect(()=>{if(typeof window>"u")return;const a=window.location.origin&&window.location.origin!=="null"?window.location.origin:"*",p=f=>{if(a!=="*"&&f.origin!==a)return;const g=f.data;!g||g.type!=="collapse-csmatrix-state"||m({controlsOpen:!!g.controlsOpen,nodesOpen:!!g.nodesOpen})};return window.addEventListener("message",p),()=>window.removeEventListener("message",p)},[]);const w=d.useCallback(a=>{var g;if(typeof window>"u")return;const p=(g=o.current)==null?void 0:g.contentWindow;if(!p)return;const f=window.location.origin&&window.location.origin!=="null"?window.location.origin:"*";p.postMessage({target:"csmatrix",action:a},f)},[]),b=d.useCallback(()=>{w("request-state")},[w]);d.useEffect(()=>{if(typeof window>"u")return;const a=(()=>{switch(t){case"player":return"#/player";case"player-ops":return"#/player/ops";case"gm":return"#/gm";case"gm-ops":return"#/gm/ops";case"chud":return"#/chud";case"csmatrix":return"#/csmatrix";default:return"#/hub"}})();window.location.hash!==a&&(window.location.hash=a)},[t]);const v=d.useMemo(()=>[{id:"gm-base-1",name:"Base",type:"Base"}],[]),i=d.useMemo(()=>[{id:"gm-mod-1",name:"Mod",type:"Modifier",cost:1}],[]),l=d.useMemo(()=>({id:"gm-null",name:"Null",type:"Null"}),[]);return t==="player"?e.jsx(M,{onBack:()=>s("hub"),chudDock:u,children:e.jsx(x,{showOpsSections:!1,showModifierCards:!0,showModifierCardCounter:!1,showModifierCapacity:!0,showBaseCounters:!0,showBaseAdjusters:!1})}):t==="player-ops"?e.jsx(M,{onBack:()=>s("hub"),chudDock:u,children:e.jsx(x,{storageKey:"collapse.deck-builder.v2",showBuilderSections:!1,showOpsSections:!0,lockControlsInOps:!1})}):t==="gm"?e.jsxs(S,{onBack:()=>s("hub"),chudDock:u,children:[e.jsx(D,{eyebrow:"GM Companion",title:"GM Deck & Table Tools",description:"Pure-count GM deck controls with offline storage, separate from player data.",helper:"Use this to prep encounters, lock decks, and keep the GM pool isolated."}),e.jsx(x,{storageKey:"collapse.deck-builder.gm.v1",exportPrefix:"collapse-gm-deck",baseCardsOverride:v,modCardsOverride:i,nullCardOverride:l,baseTarget:15,minNulls:5,modifierCapacityDefault:10,showCardDetails:!1,simpleCounters:!0,modCapacityAsCount:!0,showOpsSections:!1,showModifierCards:!0,showModifierCapacity:!1})]}):t==="gm-ops"?e.jsxs(S,{onBack:()=>s("hub"),chudDock:u,children:[e.jsx(D,{eyebrow:"GM Deck Ops",title:"Operational View",description:"Minimal deck operations for live sessions, keeping the GM pool locked and quick to reach.",helper:"Builder sections stay hidden; use the dock to draw, shuffle, and manage discard."}),e.jsx(x,{storageKey:"collapse.deck-builder.gm.v1",exportPrefix:"collapse-gm-deck",baseCardsOverride:v,modCardsOverride:i,nullCardOverride:l,baseTarget:15,minNulls:5,modifierCapacityDefault:10,showCardDetails:!1,simpleCounters:!0,modCapacityAsCount:!0,showBuilderSections:!1,showOpsSections:!0,lockControlsInOps:!1})]}):t==="chud"?e.jsx(N,{title:"cHUD — Compact HUD",src:`${y("")}chud/index.html`,onBack:()=>s("hub"),note:"Loaded inside the fullbuild shell."}):t==="csmatrix"?e.jsx(N,{title:"CS Matrix",src:y("csmatrix/index.html"),onBack:()=>s("hub"),note:"Campaign Support Matrix (in-app iframe).",actionsClassName:"topbar-actions topbar-actions-stack",actions:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"topbar-pill",onClick:()=>w("toggle-controls"),"aria-pressed":c.controlsOpen,children:c.controlsOpen?"Hide Controls":"Show Controls"}),e.jsx("button",{className:"topbar-pill",onClick:()=>w("toggle-nodes"),"aria-pressed":c.nodesOpen,children:c.nodesOpen?"Hide Nodes":"Show Nodes"})]}),frameRef:o,onFrameLoad:b}):e.jsxs(e.Fragment,{children:[u,e.jsx(U,{mode:n,onModeChange:a=>{r(a),s("hub")},onNavigate:a=>{s(a),r(a==="gm"||a==="gm-ops"?"gm":"player")}})]})}const T=document.getElementById("root");if(!T)throw new Error("Root element #root not found");O.createRoot(T).render(e.jsx(j.StrictMode,{children:e.jsx(A,{})}));"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/collapse/sw.js").catch(s=>{console.error("Service worker registration failed",s)})});if(typeof window<"u")try{new URLSearchParams(window.location.search).get("debug")==="overflow"&&document.documentElement.classList.add("debug-overflow")}catch{}var L;if(typeof window<"u"&&"ontouchstart"in window){(L=document.getElementById("root"))==null||L.classList.add("no-select");let t=0;document.addEventListener("touchstart",()=>{t=Date.now()},{passive:!0}),document.addEventListener("contextmenu",n=>{Date.now()-t<1e3&&n.preventDefault()},{passive:!1});let s=null;document.addEventListener("touchstart",n=>{const r=n.target instanceof Element?n.target:null;r&&r.closest&&r.closest(".selectable")||(s&&(clearTimeout(s),s=null),s=window.setTimeout(()=>{h()},450))},{passive:!0}),document.addEventListener("touchend",()=>{s&&(clearTimeout(s),s=null)},{passive:!0})}function h(){try{const t=window.getSelection&&window.getSelection();if(!t||!t.rangeCount)return;const s=t.anchorNode&&(t.anchorNode.nodeType===Node.TEXT_NODE?t.anchorNode.parentElement:t.anchorNode);if(s&&s.closest&&s.closest(".selectable"))return;t.removeAllRanges()}catch{}}function E(t){if(t.matches&&t.matches("[data-touch-blocker-ignore]")||t._touchBlockerAttached)return;getComputedStyle(t).position==="static"&&(t.style.position="relative"),t.classList.add("has-touch-blocker");const n=document.createElement("span");n.className="touch-blocker",n.setAttribute("aria-hidden","true"),n.setAttribute("tabindex","-1");let r=0,o=null,c=0,m=0;const u=()=>{o&&(clearTimeout(o),o=null)},w=i=>{if(i.pointerType&&i.pointerType!=="touch")return;const l=i.target instanceof Element?i.target:null;l&&l.closest&&l.closest(".selectable")||(r=Date.now(),c=i.clientX||0,m=i.clientY||0,u(),o=window.setTimeout(()=>{h();try{t.dispatchEvent(new MouseEvent("contextmenu",{bubbles:!0}))}catch{}o=null},350),i.preventDefault())},b=i=>{const l=i.clientX||0,a=i.clientY||0;(Math.abs(l-c)>10||Math.abs(a-m)>10)&&u()},v=i=>{if(i.pointerType&&i.pointerType!=="touch")return;o&&(clearTimeout(o),o=null);const l=Date.now()-r;r=0,l<350&&t.click()};n.addEventListener("pointerdown",w,{passive:!1}),n.addEventListener("pointermove",b,{passive:!0}),n.addEventListener("pointerup",v,{passive:!0}),n.addEventListener("touchstart",i=>{const l=i.changedTouches[0],a=i.target instanceof Element?i.target:null;a&&a.closest&&a.closest(".selectable")||(r=Date.now(),c=l.clientX||0,m=l.clientY||0,u(),o=window.setTimeout(()=>{h();try{t.dispatchEvent(new MouseEvent("contextmenu",{bubbles:!0}))}catch{}o=null},350),i.preventDefault())},{passive:!1}),n.addEventListener("touchmove",i=>{const l=i.changedTouches[0];l&&(Math.abs((l.clientX||0)-c)>10||Math.abs((l.clientY||0)-m)>10)&&u()},{passive:!0}),n.addEventListener("touchend",i=>{o&&(clearTimeout(o),o=null);const l=Date.now()-r;r=0,l<350&&t.click()},{passive:!0}),t.appendChild(n),t._touchBlockerAttached=!0}function G(){try{document.querySelectorAll('button, a[href], [role="button"], .button, .counter-btn, .card, .stat-card, .core-card, .interactive, .stat-large').forEach(t=>{t instanceof HTMLElement&&E(t)})}catch{}}if(typeof window<"u"){G();try{const t='button, a[href], [role="button"], .button, .counter-btn, .card, .stat-card, .core-card, .interactive, .stat-large';new MutationObserver(n=>{n.forEach(r=>{r.addedNodes.forEach(o=>{o instanceof HTMLElement&&(o.matches&&o.matches(t)&&E(o),o.querySelectorAll&&o.querySelectorAll(t).forEach(c=>{c instanceof HTMLElement&&E(c)}))})})}).observe(document.body,{childList:!0,subtree:!0})}catch{}}typeof window<"u"&&(document.addEventListener("selectionchange",()=>{requestAnimationFrame(h)},{passive:!0}),document.addEventListener("pointerdown",h,{passive:!0}),document.addEventListener("touchstart",h,{passive:!0}),document.addEventListener("touchmove",h,{passive:!0}),document.addEventListener("pointerup",h,{passive:!0}),document.addEventListener("touchend",h,{passive:!0}));
